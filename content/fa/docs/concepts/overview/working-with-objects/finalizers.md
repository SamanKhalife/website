---
title: Finalizers
content_type: concept
weight: 80
---

<!-- overview -->

{{<glossary_definition term_id="finalizer" length="long">}}

شما می‌توانید از finalizerها برای کنترل {{<glossary_tooltip text="garbage collection" term_id="garbage-collection">}} اشیاء {{< glossary_tooltip text="objects" term_id="object" >}} استفاده کنید تا {{<glossary_tooltip text="controllers" term_id="controller">}} را به انجام وظایف خاص پاک‌سازی قبل از حذف منبع هدف هشدار دهید.

معمولاً finalizerها کد اجرا را مشخص نمی‌کنند. به جای اینکه، آنها به طور معمول لیستی از کلیدها در یک منبع خاص مانند annotationها هستند. Kubernetes برخی از finalizerها را به طور خودکار مشخص می‌کند، اما شما همچنین می‌توانید finalizerهای خود را مشخص کنید.

## چگونگی کار finalizerها

وقتی یک منبع را با استفاده از یک فایل manifest ایجاد می‌کنید، می‌توانید finalizerها را در فیلد `metadata.finalizers` مشخص کنید. وقتی سعی می‌کنید منبع را حذف کنید، سرور API که درخواست حذف را پردازش می‌کند، مقادیر موجود در فیلد `finalizers` را می‌بیند و کارهای زیر را انجام می‌دهد:

  * شیء را تغییر می‌دهد تا یک فیلد `metadata.deletionTimestamp` با زمان شروع حذف اضافه شود.
  * جلوگیری می‌کند تا شیء حذف شود تا زمانی که همه موارد از فیلد `metadata.finalizers` آن حذف شوند.
  * یک کد وضعیت `202` (پذیرفته شده) برمی‌گرداند.

کنترل کننده مدیریت finalizer که به روزرسانی شیء با تنظیم `metadata.deletionTimestamp` را تشخیص می‌دهد، به معنی درخواست حذف شیء است. سپس کنترل کننده تلاش می‌کند تا نیازهای finalizerهای مشخص شده برای آن منبع را برآورده کند. هر بار که یک شرایط finalizer برآورده شود، کنترل کننده آن کلید را از فیلد `finalizers` منبع حذف می‌کند. وقتی فیلد `finalizers` خالی می‌شود، یک شیء با فیلد `deletionTimestamp` تنظیم شده به طور خودکار حذف می‌شود. همچنین می‌توانید از finalizerها برای جلوگیری از حذف منابع نامدار استفاده کنید.

یک مثال معمول از finalizer `kubernetes.io/pv-protection` است که جلوگیری از حذف تصادفی اشیاء `PersistentVolume` را جلوگیری می‌کند. وقتی یک شیء `PersistentVolume` توسط یک Pod استفاده می‌شود، Kubernetes finalizer `pv-protection` را اضافه می‌کند. اگر شما تلاش کنید `PersistentVolume` را حذف کنید، وارد وضعیت `Terminating` می‌شود، اما کنترل کننده نمی‌تواند آن را حذف کند زیرا finalizer وجود دارد. وقتی که Pod از استفاده از `PersistentVolume` متوقف می‌شود، Kubernetes finalizer `pv-protection` را پاک می‌کند و کنترل کننده حجم را حذف می‌کند.

{{<note>}}
* وقتی یک شیء را حذف می‌کنید، Kubernetes زمانی را برای آن شیء اضافه می‌کند و سپس به طور فوری شروع به محدود کردن تغییرات در فیلد `.metadata.finalizers` برای شیء که در حال حذف است می‌کند. شما می‌توانید finalizerهای موجود را حذف کنید (حذف یک ورود از لیست `finalizers`) اما نمی‌توانید یک finalizer جدید اضافه کنید. همچنین نمی‌توانید `deletionTimestamp` برای یک شیء را که تنظیم شده است، تغییر دهید.

* پس از درخواست حذف، نمی‌توانید این شیء را دوباره زنده کنید. تنها راه حذف آن است و ایجاد شیء مشابه جدید.
{{</note>}}

## ارجاع‌های مالکیت، برچسب‌ها و finalizerها {#owners-labels-finalizers}

مانند {{<glossary_tooltip text="labels" term_id="label">}},
[ارجاع‌های مالکیت](/docs/concepts/overview/working-with-objects/owners-dependents/)
روابط بین اشیاء در Kubernetes را توصیف می‌کنند، اما برای هدف متفاوتی استفاده می‌شوند. وقتی یک {{<glossary_tooltip text="controller" term_id="controller">}} اشیاء را مدیریت می‌کند مانند Pods، از برچسب‌ها برای ردیابی تغییرات در گروه‌های اشیاء مرتبط استفاده می‌کند. به عنوان مثال، وقتی یک {{<glossary_tooltip text="Job" term_id="job">}} یک یا چند Pod ایجاد می‌کند، کنترل‌کننده Job برچسب‌ها را به این Pods اعمال می‌کند و تغییرات در هر Pods در خوشه با همان برچسب را پیگیری می‌کند.

همچنین کنترل‌کننده Job ارجاعات مالکیت را به این Pods اضافه می‌کند که به Job اشاره دارند که Pods را ایجاد کرده است. اگر شما Job را در حالی که این Pods در حال اجرا هستند حذف کنید، Kubernetes از ارجاع‌های مالکیت (نه برچسب‌ها) برای تعیین اینکه کدام Pods در خوشه نیاز به پاک‌سازی دارند استفاده می‌کند.

هنگام شناسایی ارجاع‌های مالکیت بر روی یک منبع مقصد برای حذف، Kubernetes همچنین finalizerها را پردازش می‌کند.

در برخی موارد، finalizerها می‌توانند حذف اشیاء وابسته را مسدود کنند که می‌تواند منجر به این شود که شیء مالک مقصد برای مدتی بیشتر از انتظار حذف نشده باقی بماند. در این موقعیت‌ها، شما باید finalizerها و ارجاع‌های مالکیت را بر روی مالک مقصد و اشیاء وابسته بررسی کنید تا علت مشکل را پیدا کنید و رفع کنید.

{{<note>}}
در مواردی که اشیاء در حال حذف مانده‌اند، اجتناب کنید که به طور دستی finalizerها را حذف کنید تا اجازه دهید حذف ادامه پیدا کند. finalizerها معمولاً به منابع برای یک دلیل اضافه می‌شوند، بنابراین حذف اجباری آنها می‌تواند منجر به مشکلات در خوشه شما شود. این کار فقط باید در صورتی انجام شود که هدف finalizer درک شده باشد و به روش دیگری (مثلاً پاک‌سازی دستی برخی اشیاء وابسته) انجام شود.
{{</note>}}

## {{% heading "whatsnext" %}}

* بخوانید [استفاده از Finalizerها برای کنترل حذف](/blog/2021/05/14/using-finalizers-to-control-deletion/)
  در وب‌لاگ Kubernetes.
