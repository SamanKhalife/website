---
title: محدودیت‌های امنیتی هسته لینوکس برای پادها و کانتینرها
description: >
  بررسی ماژول‌ها و محدودیت‌های امنیتی هسته لینوکس که می‌توانید برای تقویت امنیت پادها و کانتینرهای خود استفاده کنید.
content_type: concept
weight: 100
---

<!-- overview -->

این صفحه برخی از ویژگی‌های امنیتی که در هسته لینوکس ساخته شده‌اند و می‌توانید در بارهای کاری Kubernetes خود استفاده کنید را توضیح می‌دهد. برای یادگیری نحوه اعمال این ویژگی‌ها به پادها و کانتینرهای خود، به 
[پیکربندی یک SecurityContext برای یک پاد یا کانتینر](/docs/tasks/configure-pod-container/security-context/)
مراجعه کنید.
شما باید با لینوکس و مبانی بارهای کاری Kubernetes آشنا باشید.

<!-- body -->

## اجرای بارهای کاری بدون مجوزهای root {#run-without-root}

هنگامی که یک بار کاری را در Kubernetes مستقر می‌کنید، از مشخصات پاد استفاده کنید تا آن بار کاری از اجرای به عنوان کاربر root در نود جلوگیری کند. شما می‌توانید از `securityContext` پاد برای تعریف کاربر و گروه خاص لینوکس برای فرآیندهای داخل پاد استفاده کنید و به صراحت کانتینرها را از اجرای به عنوان کاربران root محدود کنید. تنظیم این مقادیر در مانیفست پاد اولویت بالاتری نسبت به مقادیر مشابه در تصویر کانتینر دارد، که به ویژه در صورتی که شما تصاویر را که متعلق به شما نیستند اجرا می‌کنید، مفید است.

{{< caution >}}
اطمینان حاصل کنید که کاربر یا گروهی که به بار کاری اختصاص داده‌اید دارای مجوزهای لازم برای عملکرد صحیح برنامه باشد. تغییر کاربر یا گروه به یک کاربر یا گروهی که مجوزهای صحیح را ندارد می‌تواند منجر به مشکلات دسترسی به فایل یا عملیات ناموفق شود.
{{< /caution >}}

پیکربندی ویژگی‌های امنیتی هسته در این صفحه کنترل دقیقی بر روی اقدامات فرآیندها در خوشه شما فراهم می‌کند، اما مدیریت این پیکربندی‌ها در مقیاس بزرگ می‌تواند چالش‌برانگیز باشد. اجرای کانتینرها به عنوان غیر root، یا در فضای نام کاربری اگر نیاز به مجوزهای root دارید، به کاهش احتمال نیاز به اجرای قابلیت‌های امنیتی پیکربندی شده شما کمک می‌کند.

## ویژگی‌های امنیتی در هسته لینوکس {#linux-security-features}

Kubernetes به شما امکان می‌دهد ویژگی‌های هسته لینوکس را برای بهبود ایزوله‌سازی و تقویت بارهای کاری کانتینری خود پیکربندی و استفاده کنید. ویژگی‌های رایج شامل موارد زیر است:

* **حالت محاسبات امن (seccomp)**: فیلتر کردن کدام فراخوانی‌های سیستم یک فرآیند می‌تواند انجام دهد
* **AppArmor**: محدود کردن مجوزهای دسترسی برنامه‌های فردی
* **امنیت تقویت‌شده لینوکس (SELinux)**: اختصاص برچسب‌های امنیتی به اشیاء برای اجرای سیاست‌های امنیتی قابل مدیریت‌تر

برای پیکربندی تنظیمات برای یکی از این ویژگی‌ها، سیستم عاملی که برای نودهای خود انتخاب می‌کنید باید ویژگی را در هسته فعال کرده باشد. به عنوان مثال، اوبونتو 7.10 و بالاتر به طور پیش‌فرض AppArmor را فعال می‌کنند. برای اطلاع از اینکه آیا سیستم عامل شما یک ویژگی خاص را فعال می‌کند، به مستندات سیستم عامل مراجعه کنید.

شما از فیلد `securityContext` در مشخصات پاد خود برای تعریف محدودیت‌هایی که به آن فرآیندها اعمال می‌شود استفاده می‌کنید. فیلد `securityContext` همچنین از تنظیمات امنیتی دیگر پشتیبانی می‌کند، مانند قابلیت‌های خاص لینوکس یا مجوزهای دسترسی به فایل با استفاده از UID و GID. برای اطلاعات بیشتر، به
[پیکربندی یک SecurityContext برای یک پاد یا کانتینر](/docs/tasks/configure-pod-container/security-context/)
مراجعه کنید.

### seccomp

برخی از بارهای کاری شما ممکن است به مجوزهایی برای انجام اقدامات خاص به عنوان کاربر root در ماشین میزبان نود نیاز داشته باشند. لینوکس از *قابلیت‌ها* برای تقسیم مجوزهای موجود به دسته‌ها استفاده می‌کند، به طوری که فرآیندها می‌توانند مجوزهای لازم برای انجام اقدامات خاص را بدون اینکه تمام مجوزها را داشته باشند دریافت کنند. هر قابلیت مجموعه‌ای از فراخوانی‌های سیستم (syscalls) را دارد که یک فرآیند می‌تواند انجام دهد. seccomp به شما امکان می‌دهد این فراخوانی‌های سیستم فردی را محدود کنید. <!--Copied from seccomp tutorial-->
می‌تواند برای sandbox کردن مجوزهای یک فرآیند استفاده شود، با محدود کردن فراخوانی‌هایی که از فضای کاربری به هسته انجام می‌دهد.<!--End copy-->

در Kubernetes، شما از یک *زمان اجرای کانتینر* در هر نود برای اجرای کانتینرهای خود استفاده می‌کنید. زمان‌های اجرای نمونه شامل CRI-O، Docker یا containerd هستند. هر زمان اجرا به طور پیش‌فرض فقط زیرمجموعه‌ای از قابلیت‌های لینوکس را اجازه می‌دهد. شما می‌توانید فراخوانی‌های سیستم مجاز را به صورت فردی با استفاده از یک پروفایل seccomp محدودتر کنید. زمان‌های اجرای کانتینر معمولاً شامل یک پروفایل seccomp پیش‌فرض هستند. <!--Copied from seccomp tutorial-->
Kubernetes به شما امکان می‌دهد پروفایل‌های seccomp که بر روی یک نود بارگذاری شده‌اند را به طور خودکار به پادها و کانتینرهای خود اعمال کنید.<!--End copy-->

{{<note>}}
Kubernetes همچنین تنظیم `allowPrivilegeEscalation` را برای پادها و کانتینرها دارد. هنگامی که روی `false` تنظیم شود، این کار از به دست آوردن قابلیت‌های جدید توسط فرآیندها جلوگیری می‌کند و کاربران غیرمجاز را از تغییر پروفایل seccomp اعمال شده به یک پروفایل مجازتر محدود می‌کند.
{{</note>}}

برای یادگیری نحوه پیاده‌سازی seccomp در Kubernetes، به
[محدود کردن فراخوانی‌های سیستم یک کانتینر با seccomp](/docs/tutorials/security/seccomp/)
مراجعه کنید.

برای اطلاعات بیشتر در مورد seccomp، به
[Seccomp BPF](https://www.kernel.org/doc/html/latest/userspace-api/seccomp_filter.html)
در مستندات هسته لینوکس مراجعه کنید.

#### ملاحظات seccomp {#seccomp-considerations}

seccomp یک پیکربندی امنیتی سطح پایین است که فقط در صورتی که نیاز به کنترل دقیق بر روی فراخوانی‌های سیستم لینوکس دارید باید خودتان پیکربندی کنید. استفاده از seccomp، به ویژه در مقیاس بزرگ، دارای خطرات زیر است:

* پیکربندی‌ها ممکن است در هنگام به‌روزرسانی برنامه شکسته شوند
* مهاجمان هنوز می‌توانند از فراخوانی‌های سیستم مجاز برای بهره‌برداری از آسیب‌پذیری‌ها استفاده کنند
* مدیریت پروفایل برای برنامه‌های فردی در مقیاس بزرگ چالش‌برانگیز می‌شود

**توصیه**: از پروفایل seccomp پیش‌فرضی که با زمان اجرای کانتینر شما همراه است استفاده کنید. اگر به محیطی ایزوله‌تر نیاز دارید، در نظر بگیرید از یک sandbox مانند gVisor استفاده کنید. sandboxها این خطرات را با پروفایل‌های seccomp سفارشی حل می‌کنند، اما به منابع محاسباتی بیشتری در نودهای شما نیاز دارند و ممکن است با GPUها و سایر سخت‌افزارهای تخصصی ناسازگار باشند.

### AppArmor و SELinux: کنترل دسترسی اجباری مبتنی بر سیاست {#policy-based-mac}

شما می‌توانید از مکانیسم‌های کنترل دسترسی اجباری مبتنی بر سیاست لینوکس، مانند AppArmor و SELinux، برای تقویت بارهای کاری Kubernetes خود استفاده کنید.

#### AppArmor

<!-- Original text from https://kubernetes.io/docs/tutorials/security/apparmor/ -->

[AppArmor](https://apparmor.net/) یک ماژول امنیتی هسته لینوکس است که مجوزهای استاندارد مبتنی بر کاربر و گروه لینوکس را تکمیل می‌کند تا برنامه‌ها را به مجموعه محدودی از منابع محدود کند. AppArmor را می‌توان برای هر برنامه‌ای پیکربندی کرد تا سطح حمله آن را کاهش دهد و دفاع عمیق‌تری فراهم کند. این ماژول از طریق پروفایل‌هایی پیکربندی می‌شود که برای اجازه دسترسی مورد نیاز یک برنامه یا کانتینر خاص تنظیم شده‌اند، مانند قابلیت‌های لینوکس، دسترسی به شبکه و مجوزهای فایل. هر پروفایل می‌تواند در حالت اجرایی اجرا شود که دسترسی به منابع غیرمجاز را مسدود می‌کند، یا در حالت شکایتی که فقط تخلفات را گزارش می‌دهد.

AppArmor می‌تواند به شما کمک کند تا یک استقرار ایمن‌تر داشته باشید با محدود کردن کارهایی که کانتینرها مجاز به انجام آنها هستند و/یا ارائه حسابرسی بهتر از طریق لاگ‌های سیستم. زمان اجرای کانتینری که استفاده می‌کنید ممکن است با یک پروفایل AppArmor پیش‌فرض همراه باشد، یا می‌توانید از یک پروفایل سفارشی استفاده کنید.

برای یادگیری نحوه استفاده از AppArmor در Kubernetes، به
[محدود کردن دسترسی یک کانتینر به منابع با AppArmor](/docs/tutorials/security/apparmor/)
مراجعه کنید.
#### SELinux

SELinux یک ماژول امنیتی هسته لینوکس است که به شما امکان می‌دهد دسترسی یک *موضوع* خاص، مانند یک فرآیند، به فایل‌های سیستم خود را محدود کنید. شما سیاست‌های امنیتی را تعریف می‌کنید که به موضوعاتی که دارای برچسب‌های SELinux خاص هستند اعمال می‌شوند. هنگامی که یک فرآیند که دارای برچسب SELinux است تلاش می‌کند به یک فایل دسترسی پیدا کند، سرور SELinux بررسی می‌کند که آیا سیاست امنیتی آن فرآیند اجازه دسترسی را می‌دهد و تصمیم‌گیری می‌کند.

در Kubernetes، شما می‌توانید یک برچسب SELinux را در فیلد `securityContext` مانیفست خود تنظیم کنید. برچسب‌های مشخص شده به آن فرآیندها اختصاص داده می‌شوند. اگر سیاست‌های امنیتی که بر روی آن برچسب‌ها تأثیر می‌گذارد را پیکربندی کرده‌اید، هسته سیستم عامل میزبان این سیاست‌ها را اعمال می‌کند.

برای یادگیری نحوه استفاده از SELinux در Kubernetes، به
[اختصاص برچسب‌های SELinux به یک کانتینر](/docs/tasks/configure-pod-container/security-context/#assign-selinux-labels-to-a-container)
مراجعه کنید.

#### تفاوت‌های بین AppArmor و SELinux {#apparmor-selinux-diff}

سیستم عامل موجود در نودهای لینوکس شما معمولاً یکی از AppArmor یا SELinux را شامل می‌شود. هر دو مکانیزم حفاظت مشابهی ارائه می‌دهند، اما تفاوت‌هایی دارند مانند موارد زیر:

* **پیکربندی**: AppArmor از پروفایل‌ها برای تعریف دسترسی به منابع استفاده می‌کند. SELinux از سیاست‌هایی استفاده می‌کند که به برچسب‌های خاص اعمال می‌شوند.
* **اعمال سیاست**: در AppArmor، شما منابع را با استفاده از مسیرهای فایل تعریف می‌کنید. SELinux از شاخص نود (inode) یک منبع برای شناسایی آن استفاده می‌کند.

### خلاصه ویژگی‌ها {#summary}

جدول زیر موارد استفاده و دامنه هر کنترل امنیتی را توضیح می‌دهد. شما می‌توانید از همه این کنترل‌ها به طور همزمان برای ساخت یک سیستم مقاوم‌تر استفاده کنید.

<table>
  <caption>خلاصه ویژگی‌های امنیتی هسته لینوکس</caption>
  <thead>
    <tr>
      <th>ویژگی امنیتی</th>
      <th>توضیح</th>
      <th>نحوه استفاده</th>
      <th>مثال</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>seccomp</td>
      <td>محدود کردن فراخوانی‌های هسته‌ای فردی در فضای کاربری. کاهش احتمال بهره‌برداری از آسیب‌پذیری که از یک syscall محدود شده استفاده می‌کند.</td>
      <td>یک پروفایل seccomp بارگذاری شده را در مشخصات پاد یا کانتینر مشخص کنید تا محدودیت‌های آن به فرآیندهای داخل پاد اعمال شود.</td>
      <td>رد کردن syscall <code>unshare</code>، که در
      <a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2022-0185">CVE-2022-0185</a> استفاده شده است.</td>
    </tr>
    <tr>
      <td>AppArmor</td>
      <td>محدود کردن دسترسی برنامه به منابع خاص. کاهش سطح حمله برنامه. بهبود گزارش‌گیری لاگ‌ها.</td>
      <td>یک پروفایل AppArmor بارگذاری شده را در مشخصات کانتینر مشخص کنید.</td>
      <td>محدود کردن یک برنامه فقط خواندنی از نوشتن در هر مسیر فایل سیستم.</td>
    </tr>
    <tr>
      <td>SELinux</td>
      <td>محدود کردن دسترسی به منابعی مانند فایل‌ها، برنامه‌ها، پورت‌ها و فرآیندها با استفاده از برچسب‌ها و سیاست‌های امنیتی.</td>
      <td>محدودیت‌های دسترسی را برای برچسب‌های خاص مشخص کنید. فرآیندها را با آن برچسب‌ها علامت‌گذاری کنید تا محدودیت‌های دسترسی مرتبط با برچسب را اعمال کنید.</td>
      <td>محدود کردن دسترسی یک کانتینر به فایل‌های خارج از سیستم فایل خودش.</td>
    </tr>
  </tbody>
</table>

{{< note >}}
مکانیزم‌هایی مانند AppArmor و SELinux می‌توانند حفاظتی فراتر از کانتینر ارائه دهند. به عنوان مثال، می‌توانید از SELinux برای کاهش خطر
[CVE-2019-5736](https://access.redhat.com/security/cve/cve-2019-5736)
استفاده کنید.
{{< /note >}}

### ملاحظات برای مدیریت پیکربندی‌های سفارشی {#considerations-custom-configurations}

seccomp، AppArmor و SELinux معمولاً یک پیکربندی پیش‌فرض ارائه می‌دهند که حفاظت‌های پایه‌ای را فراهم می‌کند. همچنین می‌توانید پروفایل‌ها و سیاست‌های سفارشی ایجاد کنید که نیازهای بارهای کاری شما را برآورده کنند. مدیریت و توزیع این پیکربندی‌های سفارشی در مقیاس بزرگ ممکن است چالش‌برانگیز باشد، به ویژه اگر از هر سه ویژگی به طور همزمان استفاده کنید. برای کمک به مدیریت این پیکربندی‌ها در مقیاس، از ابزاری مانند 
[Kubernetes Security Profiles Operator](https://github.com/kubernetes-sigs/security-profiles-operator)
استفاده کنید.

## ویژگی‌های امنیتی سطح هسته و کانتینرهای دارای مجوز {#kernel-security-features-privileged-containers}

Kubernetes به شما امکان می‌دهد برخی از کانتینرهای مورد اعتماد را در حالت *دارای مجوز* اجرا کنید. هر کانتینر در یک پاد می‌تواند در حالت دارای مجوز اجرا شود تا از قابلیت‌های مدیریتی سیستم عامل که در غیر این صورت غیرقابل دسترس هستند استفاده کند. این امکان برای هر دو سیستم عامل ویندوز و لینوکس موجود است.

کانتینرهای دارای مجوز صراحتاً برخی از محدودیت‌های هسته لینوکس که ممکن است در بارهای کاری خود استفاده کنید را لغو می‌کنند، به شرح زیر:

* **seccomp**: کانتینرهای دارای مجوز به عنوان پروفایل seccomp `Unconfined` اجرا می‌شوند و هر پروفایل seccomp که در مانیفست خود مشخص کرده‌اید را لغو می‌کنند.
* **AppArmor**: کانتینرهای دارای مجوز هر پروفایل AppArmor اعمال شده را نادیده می‌گیرند.
* **SELinux**: کانتینرهای دارای مجوز به عنوان دامنه `unconfined_t` اجرا می‌شوند.

### کانتینرهای دارای مجوز {#privileged-containers}

هر کانتینر در یک پاد می‌تواند با تنظیم فیلد `privileged: true` در
[`securityContext`](/docs/tasks/configure-pod-container/security-context/)
کانتینر، *حالت دارای مجوز* را فعال کند. کانتینرهای دارای مجوز بسیاری از تنظیمات سختگیرانه دیگر مانند پروفایل seccomp اعمال شده، پروفایل AppArmor یا محدودیت‌های SELinux را لغو یا بی‌اثر می‌کنند. کانتینرهای دارای مجوز تمام قابلیت‌های لینوکس را دریافت می‌کنند، از جمله قابلیت‌هایی که به آنها نیاز ندارند. به عنوان مثال، یک کاربر root در یک کانتینر دارای مجوز ممکن است قادر به استفاده از قابلیت‌های `CAP_SYS_ADMIN` و `CAP_NET_ADMIN` بر روی نود باشد، که تنظیمات seccomp زمان اجرا و محدودیت‌های دیگر را دور می‌زند.

در اکثر موارد، باید از استفاده از کانتینرهای دارای مجوز اجتناب کنید و به جای آن قابلیت‌های خاصی که کانتینر شما نیاز دارد را با استفاده از فیلد `capabilities` در فیلد `securityContext` اعطا کنید. فقط در صورتی از حالت دارای مجوز استفاده کنید که قابلیت خاصی داشته باشید که نمی‌توانید با `securityContext` اعطا کنید. این مفید است برای کانتینرهایی که می‌خواهند از قابلیت‌های مدیریتی سیستم عامل مانند دستکاری پشته شبکه یا دسترسی به دستگاه‌های سخت‌افزاری استفاده کنند.

در نسخه 1.26 و بعد از Kubernetes، شما همچنین می‌توانید کانتینرهای ویندوزی را به صورت مشابه در حالت دارای مجوز اجرا کنید با تنظیم پرچم `windowsOptions.hostProcess` بر روی context امنیتی مشخصات پاد. برای جزئیات و دستورالعمل‌ها، به
[ایجاد یک پاد Windows HostProcess](/docs/tasks/configure-pod-container/create-hostprocess-pod/)
مراجعه کنید.

## توصیه‌ها و بهترین روش‌ها {#recommendations-best-practices}

* قبل از پیکربندی قابلیت‌های امنیتی سطح هسته، باید ایزوله‌سازی سطح شبکه را در نظر بگیرید. برای اطلاعات بیشتر،
  [چک لیست امنیتی](/docs/concepts/security/security-checklist/#network-security)
  را مطالعه کنید.
* مگر در موارد ضروری، بارهای کاری لینوکس را به عنوان غیر-root اجرا کنید با تنظیم شناسه‌های کاربر و گروه خاص در مانیفست پاد خود و با مشخص کردن `runAsNonRoot: true`.

علاوه بر این، می‌توانید بارهای کاری را در namespace کاربران با تنظیم `hostUsers: false` در مانیفست پاد خود اجرا کنید. این به شما امکان می‌دهد کانتینرها را به عنوان کاربران root در namespace کاربر اجرا کنید، اما به عنوان کاربران غیر-root در namespace میزبان روی نود. این هنوز در مراحل اولیه توسعه است و ممکن است سطح پشتیبانی مورد نیاز شما را نداشته باشد. برای دستورالعمل‌ها، به
[استفاده از namespace کاربر با یک پاد](/docs/tasks/configure-pod-container/user-namespaces/)
مراجعه کنید.

## {{% heading "whatsnext" %}}

* [نحوه استفاده از AppArmor را یاد بگیرید](/docs/tutorials/security/apparmor/)
* [نحوه استفاده از seccomp را یاد بگیرید](/docs/tutorials/security/seccomp/)
* [نحوه استفاده از SELinux را یاد بگیرید](/docs/tasks/configure-pod-container/security-context/#assign-selinux-labels-to-a-container)
