---
title: "ریسک‌های عبور API سرور Kubernetes"
description: >
  اطلاعات معماری امنیتی مرتبط با سرور API و سایر اجزای Kubernetes
content_type: concept
weight: 90
---

<!-- مرور -->

سرور API Kubernetes نقطه ورود اصلی برای افراد خارجی (کاربران و خدمات) است که با آن تعامل دارند.

به عنوان بخشی از این نقش، سرور API دارای کنترل‌های امنیتی اصلی ساخته‌شده است، مانند ورود به ثبت و ضبط {{< glossary_tooltip text="admission controllers" term_id="admission-controller" >}}. با این حال، روش‌هایی برای تغییر پیکربندی یا محتوای کلاستر وجود دارد که این کنترل‌ها را طی می‌کند.

این صفحه روش‌هایی را توصیف می‌کند که کنترل‌های امنیتی داخلی که در سرور API Kubernetes داخل شده‌اند می‌توانند عبور کنند، تا اپراتورهای کلاستر و معماران امنیتی مطمئن شوند که این عبورها به درستی محدود شده‌اند.

<!-- بدنه -->

## پاد‌های استاتیک {#static-pods}

{{< glossary_tooltip text="kubelet" term_id="kubelet" >}} روی هر گره، هر نمونه را که در یک دایرکتوری نام‌گذاری‌شده یا از یک URL خاص به عنوان [*پادهای استاتیک*](/docs/tasks/configure-pod-container/static-pod) در کلاستر شما ذخیره یا به اشتراک گذاشته می‌شود، بارگیری و مدیریت می‌کند. سرور API این پادهای استاتیک را مدیریت نمی‌کند. یک حمله‌گر با دسترسی نوشتن به این مکان می‌تواند پیکربندی پادهای استاتیک را که از این منبع بارگیری می‌شود، تغییر دهد یا ممکن است پادهای استاتیک جدیدی معرفی کند.

پادهای استاتیک از دسترسی به اشیاء دیگر در API Kubernetes محدود هستند. به عنوان مثال، شما نمی‌توانید یک پاد استاتیک را پیکربندی کنید تا یک راز را از کلاستر بارگیری کند. با این حال، این پادها می‌توانند اقدامات امنیتی دیگری مانند استفاده از مونت‌های `hostPath` از زیربنای گره‌ای استفاده کنند.

به طور پیش‌فرض، kubelet یک {{< glossary_tooltip text="mirror pod" term_id="mirror-pod" >}} ایجاد می‌کند تا پادهای استاتیک در API Kubernetes قابل مشاهده باشند. با این حال، اگر حمله‌گر از یک نام فضای نام نامعتبر استفاده کند هنگام ایجاد پاد، در API Kubernetes قابل مشاهده نخواهد بود و تنها می‌تواند توسط ابزارهایی که دسترسی به میزبان (ها) دارند، کشف شود.

اگر یک پاد استاتیک در ارزیابی ورود شکست بخورد، kubelet پاد را با سرور API ثبت نخواهد کرد. با این حال، پاد هنوز در گره اجرا می‌شود. برای اطلاعات بیشتر، به [موضوع kubeadm # 1541](https://github.com/kubernetes/kubeadm/issues/1541#issuecomment-487331701) مراجعه کنید.

### مهارت‌ها {#static-pods-mitigations}

- تنها [ویژگی تابعی پاد استاتیک kubelet را فعال کنید](/docs/tasks/configure-pod-container/static-pod/#static-pod-creation) اگر توسط گره نیاز باشد.
- اگر یک گره از قابلیت پاد استاتیک استفاده می‌کند، دسترسی به فایل‌های سیستم فایلی برای دایرکتوری یا URL پادهای استاتیک را تنها به کاربرانی که به دسترسی نیاز دارند محدود کنید.
- دسترسی به پارامترها و فایل‌های پیکربندی kubelet را محدود کنید تا جلوگیری از یک حمله‌گر که مسیر یا URL پاد استاتیک را تنظیم کند.
- بازرسی منظم و گزارش مرکزی را در مورد تمام دسترسی‌ها به دایرکتوری‌ها یا مکان‌های ذخیره سازی وب که پادهای استاتیک را میزبانی می‌کنند و فایل‌های پیکربندی kubelet.

## API kubelet {#kubelet-api}

kubelet یک API HTTP ارائه می‌دهد که به طور معمول بر روی پورت TCP 10250 بر روی گره‌های کارگر کلاستر انتشار می‌یابد. این API ممکن است همچنین بر روی گره‌های صفحه کنترل انتشار یابد، از بسته‌ی Kubernetes که در استفاده است. دسترسی مستقیم به این API امکان فراهم کردن اطلاعات در مورد پادهای در حال اجرا بر روی یک گره، لاگ‌های از آن پادها و اجرای دستورات در هر کانتینر در حال اجرا بر روی گره را فراهم می‌کند.

وقتی کاربران کلاستر Kubernetes دسترسی RBAC به منابع زیر-منبع `Node` دارند، این دسترسی به عنوان مجوز برای تعامل با API kubelet عمل می‌کند. دسترسی دقیق به منابع زیر-منبع بستگی به این دارد که چه نوع دسترسی به کدام زیرمنبع اعطا شده است، به تفصیل در [اجازه‌دهی kubelet](/docs/reference/access-authn-authz/kubelet-authn-authz/#kubelet-authorization) شرح داده شده است.

دسترسی مستقیم به API kubelet تحت کنترل ورود قرار نمی‌گیرد و توسط ثبت ورود Kubernetes لاگ نمی‌شود. یک حمله‌گر با دسترسی مستقیم به این API ممکن است توانایی اجرای کنترل‌هایی را که عملیات خاصی را کشف یا جلوگیری می‌کنند را داشته باشد.

API kubelet می‌تواند به چندین روش برای احراز هویت درخواست‌ها پیکربندی شود. به طور پیش‌فرض، پیکربندی kubelet اجازه دسترسی بی‌هویت را فراهم می‌کند. اکثر ارائه‌دهندگان Kubernetes پیش‌فرض را به استفاده از وبهوک و احراز هویت گواهی‌نامه تغییر می‌دهند. این امکان را به صفحه کنترل می‌دهد تا مطمئن شود که خواننده توانایی دسترسی به منابع `nodes` API را دارد یا زیرمنبع‌های فرعی. دسترسی بی‌هویت پیش‌فرض این ادعا را با صفحه کنترل فراهم نمی‌کند.

### مهارت‌ها

- دسترسی به زیرمنبع‌های `nodes` API object را با استفاده از مکانیزم‌هایی مانند [RBAC](/docs/reference/access-authn-authz/rbac/) محدود کنید. این دسترسی را فقط در صورت نیاز مانند توسط خدمات نظارتی اعطا کنید.
- دسترسی به پورت kubelet را محدود کنید. فقط از محدوده‌های آدرس IP مشخص و قابل اعتماد برای دسترسی به این پورت استفاده کنید.
- اطمینان حاصل کنید که [احراز هویت kubelet](/docs/reference/access-authn-authz/kubelet-authn-authz/#kubelet-authentication) به حالت وب‌هوک یا گواهی‌نامه تنظیم شده باشد.
- اطمینان حاصل شود که پورت خواننده بدون احراز هویت "read-only" kubelet در کلاستر فعال نشده است.

## API etcd

کلاسترهای Kubernetes از etcd به عنوان یک فضای ذخیره‌سازی استفاده می‌کنند. سرویس `etcd` بر روی پورت TCP 2379 گوش می‌دهد. تنها مشتریانی که به این API نیاز دارند، سرور API Kubernetes و هر ابزار پشتیبانی هستند که استفاده می‌کنید. دسترسی مستقیم به این API امکان فراهم کردن اطلاعات یا اصلاح داده‌های نگهداری شده در کلاستر را فراهم می‌کند.

دسترسی به API etcd معمولاً با استفاده از احراز هویت گواهی‌نامه مشتری مدیریت می‌شود. هر گواهی‌نامه صادر شده توسط یک موسسه گواهی‌نامه که etcd به آن اعتماد دارد، اجازه دسترسی کامل به داده‌های ذخیره‌شده در داخل etcd را فراهم می‌کند.

دسترسی مستقیم به etcd تحت کنترل ورود Kubernetes قرار نمی‌گیرد و توسط ثبت ورود Kubernetes لاگ نمی‌شود. یک حمله‌گر که دسترسی خواندن به کلید خصوصی گواهی مشتری etcd سرور API را داشته باشد (یا می‌تواند یک گواهی مشتری جدید با اعتمادی داده‌شده ایجاد کند) می‌تواند با دسترسی به مخفی‌گاه‌های کلاستر اطلاعات یا دسترسی به قوانین دسترسی را به دست آورد. حتی بدون افزایش امتیازهای RBAC Kubernetes خود، یک حمله‌گر که می‌تواند etcd را تغییر دهد، می‌تواند هر موجودیت API را بازیابی کند یا بارگذاری مجدد کارکردهای کاری داخل کلاستر.

بسیاری از ارائه‌دهندگان Kubernetes etcd را به استفاده از TLS دوطرفه پیکربندی می‌کنند (هر دو کاربر و سرور گواهی می‌کنند). هیچ پیاده‌سازی پذیرفته‌شده گسترده از مدل اجازه‌دهی برای etcd وجود ندارد، هر چند که این ویژگی موجود است. از آنجا که هیچ مدل اجازه‌دهی وجود ندارد، هر گواهی‌نامه‌ای که دسترسی مشتری به etcd را دارد، می‌تواند برای دسترسی کامل به etcd استفاده شود. به طور معمول، گواهی‌نامه‌های مشتری etcd که فقط برای چک‌کردن وضعیت سلامت استفاده می‌شوند همچنین می‌توانند دسترسی کامل به خواندن و نوشتن را فراهم کنند.

### مهارت‌ها {#etcd-api-mitigations}

- اطمینان حاصل کنید که موسسه گواهی‌نامه‌ای که توسط etcd اعتماد دارد فقط برای احراز هویت به آن خدمت می‌کند.
- دسترسی به کلید خصوصی برای گواهی‌نامه سرور etcd، و به گواهی‌نامه و کلید مشتری API سرور را کنترل کنید.
- در نظر بگیرید که دسترسی به پورت etcd را در سطح شبکه محدود کنید تا فقط از محدوده‌های آدرس IP مشخص و قابل اعتماد دسترسی داشته باشید.

## سوکت اجرایی ظرف کانتینر {#runtime-socket}

در هر نود در یک کلاستر Kubernetes، دسترسی به تعامل با کانتینرها توسط زمینه اجرای کانتینر (یا اجراها، اگر بیشتر از یکی پیکربندی کرده‌اید) کنترل می‌شود. به طور معمول، اجراهای زمینه اجرای یک سوکت یونیکس را ارائه می‌دهد که kubelet می‌تواند به آن دسترسی داشته باشد. یک حمله‌گر با دسترسی به این سوکت می‌تواند کانتینرهای جدیدی را آغاز یا با کانتینرهای در حال اجرا تعامل کند.

در سطح کلاستر، تأثیر این دسترسی به این سوکت به توجه به آنکه آیا کانتینرهایی که بر روی نود تخریب شده اجازه دسترسی به رازها یا داده‌های سری هستند که یک حمله‌گر می‌تواند از آن برای افزایش امتیاز به نودهای دیگر یا اجزاء پلان کنترل استفاده کند.

### مهارت‌ها {#runtime-socket-mitigations}

- اطمینان حاصل کنید که دسترسی به سوکت‌های زمینه اجرای کانتینر به دقت کنترل می‌شود. هنگامی که امکان پذیر است، دسترسی به این دسترسی را به کاربر `root` محدود کنید.
- kubelet را از سایر اجزاء موجود بر روی نود جدا کنید، با استفاده از مکانیزم‌هایی مانند فضای نام هسته لینوکس.
- اطمینان حاصل کنید که دسترسی به استفاده از [`hostPath` mounts](/docs/concepts/storage/volumes/#hostpath) را که شامل سوکت زمینه اجرای کانتینر می‌شود، محدود کنید، ساختارهای پدر یا پدر را به صورت مستقیم یا توسط نصب کنید. همچنین، `hostPath` mounts باید به عنوان فقط خواندنی تنظیم شده باشد تا مخاطرات حذف دایرکتوری را از طریق حفاظت محیطی حذف کنید.
- دسترسی کاربر به نودها را محدود کنید، و به ویژه دسترسی سوپرکاربر به نودها را محدود کنید.
