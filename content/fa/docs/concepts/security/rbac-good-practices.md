---
title: شیوه‌های خوب کنترل دسترسی بر اساس نقش
content_type: مفهوم
weight: 60
---

<!-- مرور -->

کوبرنتیز {{< glossary_tooltip text="RBAC" term_id="rbac" >}} یکی از کنترل‌های اصلی امنیتی است که اطمینان می‌دهد کاربران و بارگذاری‌های خوشه فقط به منابعی دسترسی داشته باشند که برای اجرای نقش‌هایشان لازم است. اهمیت دارد که هنگام طراحی مجوزها برای کاربران خوشه، مدیر خوشه مناطقی را که افزایش امتیاز ممکن است رخ دهد، درک کند تا خطر دسترسی افزونه که منجر به وقوع حوادث امنیتی می‌شود، کاهش یابد.

این شیوه‌های خوب باید همراه با [مستندات کلی RBAC](/docs/reference/access-authn-authz/rbac/#restrictions-on-role-creation-or-update) مطالعه شود.

<!-- بدنه -->

## شیوه‌های عمومی خوب

### کمترین امتیاز

ایده‌آل این است که حقوق RBAC حداقلی به کاربران و حساب‌های سرویس اختصاص یابد. فقط مجوزهای لازم برای عملکرد آن‌ها باید استفاده شود. در حالی که هر خوشه ممکن است متفاوت باشد، برخی از قوانین عمومی که می‌توان به کار برد عبارتند از:

- اختصاص مجوزها به سطح فضای نام که امکان استفاده از RoleBindings را برای دادن حقوق به کاربران فقط در یک فضای خاص فراهم می‌کند، به جای ClusterRoleBindings.
- اجتناب از اختصاص مجوزهای ویلدکارد در صورت امکان، به ویژه به تمام منابع. زیرا که کوبرنتیز یک سیستم گسترش‌پذیر است، اختصاص دسترسی ویلدکارد حق دسترسی به همه انواع اشیاء که در حال حاضر در خوشه وجود دارند، و همچنین به همه انواع اشیاء که در آینده ایجاد می‌شوند را می‌دهد.
- مدیران باید حساب‌های `cluster-admin` را به جز در موارد خاص استفاده نکنند. اختصاص یک حساب با امتیازات کمتر با [حقوق تقلید](/docs/reference/access-authn-authz/authentication/#user-impersonation) می‌تواند از اصلاحات تصادفی منابع خوشه جلوگیری کند.
- اضافه کردن کاربران به گروه `system:masters` اجتناب شود. هر کاربری که عضو این گروه باشد، تمام چک‌های حقوق RBAC را دور می‌زند و همیشه دسترسی سوپرکاربر بدون محدودیت را دارد که با حذف RoleBindings یا ClusterRoleBindings نمی‌توان آن را لغو کرد. به عنوان یک طرف، اگر یک خوشه از وب‌های مجوزدهی استفاده می‌کند، عضویت در این گروه همچنین باعث می‌شود که از این وب‌ها گذر کند (درخواست‌های از کاربرانی که عضو این گروه هستند، هرگز به وب‌ها نمی‌رود)

### کمینه کردن توزیع توکن‌های امتیازات

ایده‌آل، پادها نباید به حساب‌های سرویسی اختصاص داده شوند که دارای امتیازات قدرتمند هستند (برای مثال، هر یک از امتیازات ذکر شده در [ریسک‌های افزایش امتیاز](#privilege-escalation-risks)). در مواردی که یک بارگذاری نیاز به امتیازات قدرتمند دارد، شیوه‌های زیر را در نظر بگیرید:

- محدود کردن تعداد گره‌هایی که پادهای قدرتمند را اجرا می‌کنند. اطمینان حاصل کنید که هر DaemonSet که اجرا می‌کنید، ضروری است و با حداقل امتیاز به عنوان محدوده اجرا می‌کنید تا شعاع اسکپ‌های ظرفیتی محدود شود.
- اجتناب از اجرای پادهای قدرتمند همراه با اولویت‌هایی که ناامید یا عموماً عمومی هستند. در نظر بگیرید استفاده از [Taints و Toleration](/docs/concepts/scheduling-eviction/taint-and-toleration/),
  [NodeAffinity](/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity), یا
  [PodAntiAffinity](/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity)
  تا اطمینان حاصل کنید که پادها ناامید یا کمتر اعتماد دار همراه با پادهای کمتر اعتمادی اجرا نمی‌شوند. به ویژه توجه ویژه به شرایطی که پادهای کمتر اعتمادی به استاندارد امنیتی Pod **محدود** نمی‌رسند.

### تقویت امنیت

کوبرنتیز به طور پیش‌فرض به ارائه دسترسی می‌پردازد که احتمالاً در هر خوشه لازم نیست. بررسی حقوق RBAC ارائه شده به طور پیش‌فرض می‌تواند فرصت‌هایی برای تقویت امنیت ارائه دهد. به طور کلی، تغییرات باید به حقوق ارائه شده به حساب‌های `system:` اعمال نشود تعدادی از گزینه‌های تقویت حقوق خوشه وجود دارند:

- بررسی پیوستن برای گروه `system:unauthenticated` و حذف آن‌ها در صورت امکان، زیرا این موضوع دسترسی به هر کسی که می‌تواند با سرور API در سطح شبکه تماس برقرار کند را فراهم می‌کند.
- اجتناب از اتوماتیک اتصال به‌طور پیش‌فرض از توکن‌های حساب‌های سرویس با تنظیم `automountServiceAccountToken: false`. برای جزئیات بیشتر، به [استفاده از توکن حساب سرویس پیش‌فرض](/docs/tasks/configure-pod-container/configure-service-account/#use-the-default-service-account-to-access-the-api-server) مراجعه کنید. تنظیم این مقدار برای یک Pod تنظیمات حساب سرویس را بازنویس می‌کند، کارهایی که نیاز به توکن‌های حساب‌های سرویس دارند، می‌توانند هنوز آنها را نصب کنند.

### بررسی دوره‌ای

بررسی دوره‌ای تنظیمات Kubernetes RBAC برای ورودی‌های اضافی و افزایش امتیازات ممکن است ضروری باشد. اگر یک حمله‌کننده قادر به ایجاد یک حساب کاربری با همان نامی است که کاربر حذف شده، او می‌تواند به طور خودکار همه حقوق کاربر حذف شده را به ارث ببرد، به ویژه حقوقی که به آن کاربر اختصاص داده شده است.

## RBAC کوبرنتیز - ریسک‌های افزایش امتیاز {#privilege-escalation-risks}

در کوبرنتیز RBAC، تعدادی از امتیازات وجود دارند که اگر داده شود، می‌توانند به یک کاربر یا حساب سرویس امکان افزایش امتیازات خود را در خوشه یا تأثیر بر سیستم‌های خارج از خوشه بدهند.

این بخش برای ارائه دیدگاهی از نقاطی است که اپراتورهای خوشه باید مراقب باشند، تا اطمینان حاصل کنند که از طریق این وقایع از دسترسی به خوشه‌ها بیشتر از آنچه که قرار است اجازه دهند، استفاده نکنند.

### لیست کردن اسرار

از طرف دیگر، این واضح است که اجازه دادن به دسترسی `get` بر روی Secrets به کاربر این امکان را می‌دهد که محتویات خود را بخواند. همچنین اهمیت دارد که اجازه دادن به دسترسی `list` و `watch` به کاربران همچنین می‌تواند به آنها اجازه دهد تا محتویات Secrets را فاش کنند.
برای مثال، وقتی یک پاسخ لیست برگردانده می‌شود (برای مثال از طریق `kubectl get secrets -A -o yaml`، پاسخ شامل محتوای تمام Secrets است.

### ایجاد بارگذاری

اجازه دادن به ایجاد بارگذاری‌ها (پادها، یا [منابع بارگذاری](/docs/concepts/workloads/controllers/) که پادها را مدیریت می‌کنند) در یک فضای نام به طور ضمنی دسترسی به منابع زیادی دیگر در آن فضای نام را اختصاص می‌دهد، مانند Secrets، ConfigMaps، و PersistentVolumes که می‌توانند در پادها نصب شوند. به علاوه، از آنجا که پادها می‌توانند به عنوان هر [ServiceAccount](/docs/reference/access-authn-authz/service-accounts-admin/) دونویس، اجازه دادن به ایجاد بارگذاری‌ها همچنین به طور ضمنی دسترسی API به سطوح هر حساب سرویس در آن فضای نام را اختصاص می‌دهد.

کاربرانی که می‌توانند پادهای مجوزمند را اجرا کنند، می‌توانند از آن دسترسی استفاده کنند تا به دسترسی گره دسترسی پیدا کنند و احتمالاً امتیازات خود را به بالا ببرند. در مواردی که به یک کاربر یا موجود باورنکردنی اجازه می‌دهید که پادهای امنیتی مناسب و جدا شده را ایجاد کند، باید یا **استاندارد Baseline** یا **استاندارد Restricted** Pod Security را اجرا کنید. می‌توانید از [پذیرش امنیت پاد](/docs/concepts/security/pod-security-admission/) یا مکانیزم‌های دیگر (سوم) استفاده کنید تا اجرای اجرای اجرای این مکانیزم‌ها را پیاده سازی کنید.

به این دلیل است که باید از فضاها برای جدا کردن منابع مورد نیاز سطوح مختلف اعتماد یا تنانس استفاده شود. هنوز به عنوان یک شیوه خوب محسوب می‌شود که باید [کمترین امتیاز](#least-privilege) را دنبال کنید و مجموعه حداقل امتیازات را تخصیص دهید، اما مرزهای درون یک فضای نام باید ضعیف مورد نظر قرار گیرد.
### ایجاد حجم دائمی

اگر کسی - یا برنامه‌ای - مجاز به ایجاد PersistentVolumes دلخواه باشد، این دسترسی شامل ایجاد حجم‌های `hostPath` می‌شود که به این معنی است که یک Pod به فایل‌سیستم(های) میزبان زیرین روی نود مربوطه دسترسی پیدا می‌کند. اعطای این قابلیت یک ریسک امنیتی است.

وجود چندین راهی برای یک کانتینر با دسترسی نامحدود به فایل‌سیستم میزبان برای افزایش دسترسی‌هاست، شامل خواندن داده‌ها از کانتینرهای دیگر و سوءاستفاده از اعتبارات خدمات سیستمی مانند Kubelet.

شما باید تنها به کاربران (اپراتورهای خوشه) که نیاز به این دسترسی برای کارهایشان دارند و از افرادی که به آن‌ها اعتماد دارید، دسترسی ایجاد اشیاء PersistentVolume را اعطا کنید. همچنین، اجزای کنترل پلان Kubernetes که براساس درخواست‌های PersistentVolumeClaim حجم‌های PersistentVolume ایجاد می‌کنند (که برای تامین خودکار پیکربندی شده‌اند)، باید دسترسی به ایجاد PersistentVolume داشته باشند. این معمولاً توسط ارائه‌دهنده Kubernetes یا توسط اپراتور هنگام نصب یک درایور CSI پیکربندی می‌شود.

در جایی که دسترسی به ذخیره‌سازی دائمی نیاز است، ادمین‌های اعتماد بخش باید PersistentVolumes را ایجاد کنند، و کاربران محدود باید از PersistentVolumeClaims برای دسترسی به ذخیره‌سازی استفاده کنند.

### دسترسی به زیرمنبع `proxy` از نودها

کاربرانی که دسترسی به زیرمنبع proxy از اشیاء node دارند، حق دسترسی به API Kubelet را دارند که اجازه اجرای دستورات در هر Pod روی نودهایی که به آن‌ها دسترسی دارند، می‌دهد. این دسترسی از ثبت وقایع بررسی و کنترل پذیرش عبور می‌کند، بنابراین قبل از اعطای حق به این منبع، باید مواردی را در نظر گرفت.

### فعل escalate

بطور کلی، سیستم RBAC جلوگیری می‌کند که کاربران بتوانند clusterrole با حقوق بیشتر از حقوقی که دارند، ایجاد کنند. استثناء این موضوع، فعل `escalate` است. همانطور که در [مستندات RBAC](/docs/reference/access-authn-authz/rbac/#restrictions-on-role-creation-or-update) ذکر شده است، کاربران با این حق می‌توانند به طور موثر از امتیازات خود ارتقا دهند.

### فعل bind

مشابه فعل `escalate`، اعطای این حق به کاربران امکان می‌دهد که از حفاظت‌های داخلی Kubernetes در برابر ارتقاء امتیازات عمدی گذر کنند و به آن‌ها اجازه می‌دهد که بایندینگ به نقش‌ها با حقوقی که قبلاً نداشتند، ایجاد کنند.

### فعل impersonate

این فعل به کاربران اجازه می‌دهد که به عنوان کاربران دیگر در خوشه شخصیت پذیرفته و حقوق آن‌ها را بدست آورند. باید در اختیار داشته باشید که هنگام اعطای این حق، از این حق استفاده نمایید تا اطمینان حاصل شود که از طریق یکی از حساب‌های تقلبی، اجازه‌های بیش از حد ندهید.

### CSRs و صدور گواهی‌نامه

API CSR امکان صدور گواهی‌نامه‌های جدید مشتری را برای کاربران با حقوق `create` به CSRs و حقوق `update` بر روی `certificatesigningrequests/approval` که امضای آن `kubernetes.io/kube-apiserver-client` است، می‌دهد. این گواهی‌نامه‌های مشتری می‌توانند نام‌های دلخواهی شامل تکراری از مؤلفه‌های سیستم Kubernetes داشته باشند. این در واقع به ارتقای امتیازات منجر می‌شود.

### درخواست Token

کاربران با حقوق `create` بر روی `serviceaccounts/token` می‌توانند TokenRequests ایجاد کنند تا توکن‌ها برای حساب‌های سرویس موجود صادر کنند.

### کنترل‌های وبهوک‌های پذیرش

کاربران با کنترل بر روی `validatingwebhookconfigurations` یا `mutatingwebhookconfigurations` می‌توانند بهبودی که می‌تواند هر شیءی که وارد خوشه می‌شود را مطالعه کند و در مورد webhookهای mutate، همچنین شیء‌های وارد شده را mutate کند.

### اصلاح فضای نام

کاربرانی که می‌توانند عملیات patch را بر روی اشیاء فضای نام انجام دهند (توسط RoleBinding مربوط به یک Role با آن دسترسی)، می‌توانند برچسب‌ها را در آن فضای نام اصلاح کنند. در خوشه‌هایی که از Admission امنیت Pod استفاده می‌کنند، این ممکن است به کاربر اجازه دهد ت

ا فضای نام را برای سیاستی که توسط مدیران قرار داده شده است، پیکربندی کند. برای خوشه‌هایی که از NetworkPolicy استفاده می‌کنند، ممکن است به کاربران اجازه دهد برچسب‌هایی را تنظیم کنند که به طور غیرمستقیم به دسترسی به خدماتی که مدیریت نکرده است، منجر می‌شود.

## خطرات سرویس انکار دسترسی Kubernetes RBAC {#denial-of-service-risks}

### سرویس انکار دسترسی ایجاد شیء {#object-creation-dos}

کاربرانی که حقوق ایجاد اشیاء را در یک خوشه دارند، ممکن است بتوانند اشیاء بسیار بزرگ کافی برای ایجاد شرایط سرویس انکار دسترسی بر اساس اندازه یا تعداد اشیاء ایجاد کنند، همانطور که در [مسئله OOM حمله‌ای توسط etcd که توسط Kubernetes به خطر می‌افتد](https://github.com/kubernetes/kubernetes/issues/107325) بحث شده است. این مسئله به طور خاص در خوشه‌های چند‌مستند واگذاری می‌شود، اگر کاربران نیمه‌اعتمادی یا ناامید به صورت محدود به سیستم دسترسی داشته باشند.

یک گزینه برای مقابله با این مسئله استفاده از [سرویس‌های آخرهفته](/docs/concepts/policy/resource-quotas/#object-count-quota) برای محدود کردن تعداد اشیاء که می‌توانند ایجاد شوند، است.

## {{% heading "whatsnext" %}}

* برای یادگیری بیشتر درباره RBAC، به [مستندات RBAC](/docs/reference/access-authn-authz/rbac/) مراجعه کنید.