---
title: هوک‌های چرخه زندگی کانتینر
weight: 40
reviewers:
- mikedanese
- thockin
content_type: مفهوم
---

<!-- مرور -->

این صفحه توضیح می‌دهد که چگونه کانتینرهای مدیریت شده توسط kubelet می‌توانند از چارچوب هوک‌های چرخه زندگی کانتینر استفاده کنند
برای اجرای کد‌هایی که توسط رویدادها در طول چرخه زندگی مدیریتی آن‌ها فراخوانی می‌شود.



<!-- متن -->

## مرور

مشابه فریمورک‌های زبان‌های برنامه‌نویسی که هوک‌های چرخه مؤلفه‌ها را دارند، مانند Angular، Kubernetes هوک‌های چرخه زندگی را به کانتینرها ارائه می‌دهد.
این هوک‌ها به کانتینرها امکان می‌دهند که از رویدادهای در چرخه زندگی مدیریتی آن‌ها آگاه شوند
و کدی که در یک دستگیره اجرا شود را اجرا کنند وقتی که هوک چرخه زندگی متناظر اجرا می‌شود.

## هوک‌های کانتینر

دو هوکی که به کانتینرها ارائه شده‌اند عبارتند از:

`PostStart`

این هوک فوراً پس از ایجاد یک کانتینر اجرا می‌شود.
به هیچ وجه تضمین نمی‌شود که هوک قبل از ENTRYPOINT کانتینر اجرا خواهد شد.
هیچ پارامتری به دستگیره ارسال نمی‌شود.

`PreStop`

این هوک فوراً پیش از اینکه یک کانتینر به دلیل یک درخواست API یا رویداد مدیریتی مانند شکست پروب زندگی/استارت، تداخل منابع و دیگران خاتمه یابد، فراخوانی می‌شود.
فراخوانی هوک `PreStop` ناموفق است اگر کانتینر در حالت خاتمه یا کامل قرار داشته باشد و هوک باید قبل از ارسال سیگنال TERM برای متوقف کردن کانتینر کامل شود.
شمارنده مهلت فاز خاتمه Pod قبل از اجرای هوک `PreStop` شروع می‌شود، بنابراین بدون توجه به نتیجه دستگیره، کانتینر در نهایت داخل مهلت فاز خاتمه Pod خاتمه می‌یابد.
بدین معنا که اگر هوک خیزش برای اجرا کردن کافی زمان ببرد یا متوقف شود، کانتینر نمی‌تواند به وضعیت "running" برسد.

اگر هوک `PreStop` هنگام اجرا متوقف شود، فاز Pod "Terminating" خواهد بود و تا زمانی که Pod پس از "terminationGracePeriodSeconds" خود کشته می‌شود در آنجا باقی خواهد ماند.
این مهلت آنگاهی که می‌خواهد برای هر دو مورد (هوک `PreStop` برای اجرا کردن و کانتینر به طور عادی توقف گرفته شود) اعمال می‌شود.
اگر برای مثال "terminationGracePeriodSeconds" 60 باشد و هوک 55 ثانیه زمان برای کامل شدن را طول می‌دهد و کانتینر 10 ثانیه بعد از دریافت سیگنال کامل می‌شود، آنگاه کانتینر قبل از اینکه به طور طبیعی توقف شود کشته خواهد شد، از آنجایی که "terminationGracePeriodSeconds" کمتر از زمان کل (55+10) است که برای این دو چیز لازم است.

اگر هر کدام از هوک‌های `PostStart` یا `PreStop` ناموفق باشند، کانتینر را کشته می‌کنند.

کاربران باید دستگیره‌های هوک خود را به‌طور کامل به عنوان مقدار خنک‌کننده انتخاب کنند.
با این حال، در مواردی که دستورات اجرای طولانی منطقی هستند، مانند زمانی که قبل از توقف کانتینر وضعیت را ذخیره می‌کنید، مواردی وجود دارد.

### تضمین تحویل هوک‌ها

تحویل هوک قرار است حداقل یک بار انجام شود، که بدان معنی است که هوک ممکن است برای هر رویداد داده شده چندین بار فراخوانی شود، مانند برای `PostStart` یا `PreStop`.
به هوک اجرای درست این کار را انجام دهد.

به طور کلی، فقط تحویل‌های تکی انجام می‌شود.
اگر به عنوان مثال گیرنده هوک HTTP پایین است و نمی‌تواند ترافیک را دریافت کند، هیچ تلاشی برای ارسال دوباره وجود ندارد.
با این حال، در برخی موارد نادر، تحویل دوباره ممکن است رخ دهد.
برای مثال، اگر یک kubelet در حالت عادی وسط ارسال هوک متوقف شود، پس از بازگشت kubelet ممکن است هوک دوباره ارسال شود.

### اشکال‌زدایی دستگیره‌های هوک

لاگ‌های یک دستگیره هوک در رویدادهای Pod نمایان نمی‌شوند.
اگر یک دستگیره

 به دلیل دلایلی شکست بخورد، یک رویداد پخش می‌شود.
برای `PostStart`، این رویداد `FailedPostStartHook` است،
و برای `PreStop`، این رویداد `FailedPreStopHook` است.
برای تولید یک رویداد `FailedPostStartHook` ناموفق، فایل [lifecycle-events.yaml](https://raw.githubusercontent.com/kubernetes/website/main/content/en/examples/pods/lifecycle-events.yaml) را به گونه‌ای تغییر دهید که دستور postStart به "badcommand" تغییر دهید و آن را اعمال کنید.
اینجا نمونه‌ای از خروجی نتیجه مشاهده شده از اجرای `kubectl describe pod lifecycle-demo` آمده است:

```
رویدادها:
  نوع     دلیل               سن              از              پیام
  ----     ------               ----             ----               -------
  عادی   برنامه ریزی            7s               default-scheduler  به طور موفقیت آمیز به اختصاص رسید default/lifecycle-demo به ip-XXX-XXX-XX-XX.us-east-2...
  عادی   کشیده شد               6s               kubelet            به طور موفقیت آمیز تصویر "nginx" را در 229.604315ms بکشید
  عادی   کشیدن              4s (x2 over 6s)  kubelet            کشیدن تصویر "nginx"
  عادی   ایجاد شده              4s (x2 over 5s)  kubelet            ایجاد کانتینر lifecycle-demo-container
  عادی   شروع شد              4s (x2 over 5s)  kubelet            کانتینر شروع شد lifecycle-demo-container
  هشدار  فشیق FailedPostStartHook  4s (x2 over 5s)  kubelet            اجرای هوک چرخه زندگی ([badcommand]) برای کانتینر "lifecycle-demo-container" در Pod "lifecycle-demo_default(30229739-9651-4e5a-9a32-a8f1688862db)" ناموفق بود - خطا: دستور 'badcommand' با 126 خارج شد: ، پیام: "اجرای OCI نهایی ناموفق بود: اجرای نهایی OCI ناموفق بود: exec: \"badcommand\": فایل قابل اجرا در $ PATH: ناشناخته \ r \ n"
  عادی   کشته شده              4s (x2 over 5s)  kubelet            FailedPostStartHook
  عادی   کشیده شد               4s               kubelet            به طور موفقیت آمیز تصویر "nginx" را در 215.66395ms بکشید
  هشدار  BackOff              2s (x2 over 3s)  kubelet            Back-off restart کانتینر شکست خورده
```

## {{% heading "whatsnext" %}}

* بیشتر درباره [محیط کانتینر](/docs/concepts/containers/container-environment/) بیاموزید.
* تجربه‌ای عملی پیدا کنید با
  [متصل کردن پردازنده‌ها به رویدادهای چرخه زندگی کانتینر](/docs/tasks/configure-pod-container/attach-handler-lifecycle-event/).
