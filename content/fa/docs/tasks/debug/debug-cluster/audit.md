---
title: "Auditing"
description: "کوبرنیتیس ارائه گزارش‌های امنیتی برای توالی اقدامات در کلاستر می‌کند."
weight: 20
reviewers:
- soltysh
- sttts
content_type: concept
---

## مقدمه

کوبرنیتیس **auditing** یک مجموعه یادداشت امنیتی است که توالی اقدامات را در کلاستر به صورت زمان‌بندی شده ثبت می‌کند. این گزارشات فعالیت‌هایی که توسط کاربران، برنامه‌هایی که از API کوبرنیتیس استفاده می‌کنند و خود طرح کنترل زمینه انجام می‌دهد را شامل می‌شود.

Auditing به مدیران کلاستر این امکان را می‌دهد که به سوالات زیر پاسخ دهند:

- چه اتفاقی افتاد؟
- کی اتفاق افتاد؟
- چه کسی اقدام کرد؟
- روی چه چیزی انجام شد؟
- کجا مشاهده شد؟
- از کجا شروع شد؟
- به کجا می‌رفت؟

## رکوردهای Auditing

رکوردهای auditing زندگی خود را درون کامپوننت [kube-apiserver](/docs/reference/command-line-tools-reference/kube-apiserver/) شروع می‌کنند. هر درخواست در هر مرحله از اجرای خود یک رویداد auditing تولید می‌کند که سپس طبق یک سیاست خاص پیش‌پردازش می‌شود و در یک پشتیبان نوشته می‌شود. سیاست تعیین می‌کند چه چیزی ثبت شود و پشتیبان‌ها رکوردها را ثبت می‌کنند. پشتیبان‌های فعلی شامل فایل‌های لاگ و webhooks می‌شود.

هر درخواست می‌تواند با یک _مرحله_ مرتبط ثبت شود. مراحل تعریف شده عبارتند از:

- `RequestReceived` - مرحله رویدادهای تولید شده هنگامی که handler auditing درخواست را دریافت می‌کند، و قبل از اینکه به زنجیره handler منتقل شود.
- `ResponseStarted` - بعد از ارسال سرآیند‌های پاسخ، اما قبل از ارسال بدنه پاسخ. این مرحله تنها برای درخواست‌های بلندمدت (مانند watch) تولید می‌شود.
- `ResponseComplete` - بدنه پاسخ تکمیل شده است و دیگر بایتی ارسال نخواهد شد.
- `Panic` - رویدادهای تولید شده هنگامی که یک panic رخ داده است.

{{< note >}}
پیکربندی یک [پیکربندی رویداد auditing](/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Event)
از [Event](/docs/reference/generated/kubernetes-api/{{< param "version" >}}/#event-v1-core)
متفاوت است.
{{< /note >}}

## سیاست Auditing

سیاست auditing قوانین در مورد رویدادهایی که باید ثبت شوند و داده‌هایی که باید شامل شوند را تعیین می‌کند. ساختار شی سیاست auditing در گروه API [`audit.k8s.io`](/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy)
تعریف شده است. هنگامی که یک رویداد پردازش می‌شود، با لیست قوانین به ترتیب مقایسه می‌شود. اولین قانون مطابقتی سطح auditing رویداد را تنظیم می‌کند. سطوح auditing تعریف شده عبارتند از:

- `None` - رویدادهایی که با این قانون مطابقت دارند ثبت نمی‌شوند.
- `Metadata` - فقط متاداده‌های درخواست (کاربر درخواست کننده، زمان‌نگار، منبع، فعل و غیره) ثبت می‌شود، اما بدنه درخواست یا پاسخ ثبت نمی‌شود.
- `Request` - متاداده رویداد و بدنه درخواست، اما بدنه پاسخ ثبت نمی‌شود. این برای درخواست‌های غیر منبع اعمال نمی‌شود.
- `RequestResponse` - متاداده رویداد، بدنه درخواست و پاسخ ثبت می‌شود. این برای درخواست‌های غیر منبع اعمال نمی‌شود.

می‌توانید با استفاده از پارامتر `--audit-policy-file` یک فایل با سیاست را به `kube-apiserver`
معرفی کنید. اگر پرچم حذف شود، رویدادی ثبت نمی‌شود.
لطفاً توجه داشته باشید که فیلد `rules` باید در فایل سیاست auditing فراهم شود. یک سیاست با صفر (0) قانون به عنوان غیر قانونی تلقی می‌شود.

یک نمونه فایل سیاست auditing در زیر آمده است:

{{% code_sample file="audit/audit-policy.yaml" %}}

می‌توانید از یک فایل سیاست auditing حداقل برای ثبت همه درخواست‌ها با سطح `Metadata` استفاده کنید:

```yaml
# ثبت همه درخواست‌ها با سطح Metadata.
apiVersion: audit.k8s.io/v1
kind: Policy
rules:
- level: Metadata
```

اگر شما یک پرونده تنظیمات کاربری خود را ایجاد می‌کنید، می‌توانید از پرونده تنظیمات کاربری مرتبط برای Google Container-Optimized OS به عنوان نقطه شروع استفاده کنید. شما می‌توانید نصب کنید که می‌شود directly audit policy file.
```markdown
## پشتیبانی Auditing

پشتیبان‌های auditing رویدادهای auditing را به یک ذخیره‌سازی خارجی ثبت می‌کنند. به طور پیش‌فرض، kube-apiserver دو پشتیبان را ارائه می‌دهد:

### پشتیبان log

پشتیبان log رویدادهای auditing را به فرمت [JSONlines](https://jsonlines.org/) در یک فایل ذخیره می‌کند. می‌توانید پشتیبان log را با استفاده از پرچم‌های زیر در kube-apiserver پیکربندی کنید:

- `--audit-log-path` مسیر فایل لاگ که پشتیبان log برای نوشتن رویدادهای auditing استفاده می‌کند را مشخص می‌کند. اگر این پرچم مشخص نشود، پشتیبان log غیرفعال می‌شود. استفاده از `-` به معنای استاندارد خروجی است.
- `--audit-log-maxage` حداکثر تعداد روزهای نگهداری فایل‌های قدیمی لاگ را تعیین می‌کند.
- `--audit-log-maxbackup` حداکثر تعداد فایل‌های لاگ auditing را برای نگهداری تعیین می‌کند.
- `--audit-log-maxsize` حداکثر اندازه به مگابایت فایل لاگ auditing را قبل از چرخش مشخص می‌کند.

اگر پلان کنترل کلاستر شما kube-apiserver را به عنوان یک Pod اجرا می‌کند، به خاطر داشته باشید که `hostPath`
را به مکان پرونده سیاست و فایل لاگ مانت کنید، تا رکوردهای auditing ثبت شوند.

### پشتیبان webhook

پشتیبان webhook رویدادهای auditing را به یک API وب از راه دور ارسال می‌کند. می‌توانید پشتیبان webhook را با استفاده از پرچم‌های زیر در kube-apiserver پیکربندی کنید:

- `--audit-webhook-config-file` مسیر فایل پیکربندی webhook را مشخص می‌کند. پیکربندی webhook به طور کاربردی یک [kubeconfig](/docs/tasks/access-application-cluster/configure-access-multiple-clusters) ویژه است.
- `--audit-webhook-initial-backoff` مقدار زمان انتظار پس از درخواست اولیه ناموفق قبل از تلاش مجدد را مشخص می‌کند. درخواست‌های بعدی با exponential backoff تلاش می‌شوند.

پرونده پیکربندی webhook از فرمت kubeconfig استفاده می‌کند برای تعیین آدرس از راه دور سرویس و اعتبارهای استفاده شده برای اتصال به آن.

### دسته‌بندی رویداد {#batching}

هر دو پشتیبان log و webhook از دسته‌بندی پشتیبانی می‌کنند. به عنوان مثال استفاده از webhook، لیست پرچم‌های موجود را نمایش می‌دهد. برای دریافت همان پرچم برای پشتیبان log، `webhook` را با `log` در نام پرچم جایگزین کنید. به طور پیش‌فرض، دسته‌بندی در پشتیبان webhook فعال است و در پشتیبان log غیرفعال است.

برای شناسایی دسته‌بندی در حالت `batch`، از پرچم‌های زیر استفاده می‌شود:

- `--audit-webhook-mode` استراتژی buffering را تعیین می‌کند. یکی از موارد زیر:
  - `batch` - رویدادها را buffer کرده و به صورت دسته‌ای پردازش می‌کند. این پیش‌فرض است.
  - `blocking` - پاسخ‌های سرور API را بر روی هر رویداد فردی مسدود می‌کند.
  - `blocking-strict` - مانند blocking است، اما در صورت بروز خطا در زمان ثبت auditing در مرحله RequestReceived، درخواست کامل به kube-apiserver ناموفق می‌شود.

پرچم‌های زیر فقط در حالت `batch` استفاده می‌شوند:

- `--audit-webhook-batch-buffer-size` تعداد رویدادهایی را که قبل از دسته‌بندی در buffer قرار داده شود را تعیین می‌کند. اگر نرخ رویدادهای ورودی buffer را overflow کند، رویدادها را حذف می‌کند.
- `--audit-webhook-batch-max-size` حداکثر تعداد رویدادهایی را در یک دسته تعیین می‌کند.
- `--audit-webhook-batch-max-wait` حداکثر زمانی را که قبل از دسته‌بندی یک دسته از رویدادها در queue صبر می‌کند، تعیین می‌کند.
- `--audit-webhook-batch-throttle-qps` حداکثر تعداد میانگین مجاز دسته‌هایی است که در هر ثانیه تولید می‌شود را تعیین می‌کند.
- `--audit-webhook-batch-throttle-burst` حداکثر تعداد دسته‌هایی است که در همان لحظه تولید می‌شود اگر QPS مجاز قبلاً استفاده نشده باشد را تعیین می‌کند.

## تنظیمات پارامتر

پارامترها باید برای مقابله با بار بر روی سرور API تنظیم شوند.

به عنوان مثال، اگر kube-apiserver هر ثانیه 100 درخواست دریافت کند و هر درخواست فقط در مراحل `ResponseStarted` و `ResponseComplete` auditing شود، شما باید حدود 200 رویداد auditing را در هر ثانیه تولید کنید. با فرض اینکه تا 100 رویداد در یک دسته وجود دارد، حداقل باید سطح throttling را به 2 پرس‌وجو در

 ثانیه تنظیم کنید. با فرض اینکه backend می‌تواند تا 5 ثانیه طول بکشد تا رویدادها را بنویسد، باید اندازه buffer را به 5 ثانیه رویداد تنظیم کنید؛ به عبارت دیگر: 10 دسته یا 1000 رویداد.

در اکثر موارد، پارامترهای پیش‌فرض باید کافی باشند و نیازی به نگرانی از تنظیم دستی آنها ندارید. می‌توانید به متریک‌های Prometheus زیر که توسط kube-apiserver ارائه شده است و در logs برای نظارت بر وضعیت زیرسیستم auditing استفاده کنید.

- `apiserver_audit_event_total` شامل تعداد کل رویدادهای auditing صادر شده است.
- `apiserver_audit_error_total` شامل تعداد کل رویدادهای حذف شده به دلیل خطا در هنگام صادرات است.

### قطعه لاگ {#truncate}

هر دو پشتیبان log و webhook از محدود کردن اندازه رویدادهایی که ثبت می‌شوند، پشتیبانی می‌کنند. به عنوان مثال، لیست پرچم‌های موجود برای پشتیبان log:

- `audit-log-truncate-enabled` آیا فعال بودن truncate رویداد و دسته‌بندی است.
- `audit-log-truncate-max-batch-size` حداکثر اندازه در بایت دسته ارسال شده به پشتیبان بک‌اند.
- `audit-log-truncate-max-event-size` حداکثر اندازه در بایت رویداد auditing ارسال شده به پشتیبان بک‌اند.

به طور پیش‌فرض، truncate در هر دو پشتیبان webhook و log غیرفعال است، بنابراین یک مدیر کلاستر باید `audit-log-truncate-enabled` یا `audit-webhook-truncate-enabled` را برای فعال کردن این ویژگی تنظیم کند.

## مراجعه‌ها بعدی

- آموزش [Mutating webhook auditing annotations](/docs/reference/access-authn-authz/extensible-admission-controllers/#mutating-webhook-auditing-annotations) را بخوانید.
- با خواندن مرجع پیکربندی Audit، در مورد انواع منابع [`Event`](/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Event) و [`Policy`](/docs/reference/config-api/apiserver-audit.v1/#audit-k8s-io-v1-Policy) آشنا شوید.
