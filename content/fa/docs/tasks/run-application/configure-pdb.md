---
title: مشخص کردن بودجه اختلال برای برنامه شما
content_type: task
weight: 110
min-kubernetes-server-version: v1.21
---

<!-- overview -->

{{< feature-state for_k8s_version="v1.21" state="stable" >}}

این صفحه نشان می‌دهد که چگونه می‌توانید تعداد اختلالات همزمان را که برنامه شما تجربه می‌کند محدود کنید، به طوری که امکان دسترسی بیشتر را فراهم کرده و به مدیر خوشه اجازه مدیریت نودهای خوشه را بدهید.

## {{% heading "prerequisites" %}}

{{< version-check >}}

- شما صاحب یک برنامه‌ای هستید که روی خوشه کوبرنتیز اجرا می‌شود و نیاز به دسترسی بالا دارد.
- باید بدانید چگونه [برنامه‌های بی‌حالت تکراری](/docs/tasks/run-application/run-stateless-application-deployment/) و/یا [برنامه‌های حالت‌دار تکراری](/docs/tasks/run-application/run-replicated-stateful-application/) را مستقر کنید.
- باید درباره [اختلالات پاد](/docs/concepts/workloads/pods/disruptions/) مطالعه کرده باشید.
- باید با مالک خوشه یا ارائه‌دهنده خدمات خود تأیید کنید که بودجه‌های اختلال پاد را رعایت می‌کنند.

<!-- steps -->

## محافظت از برنامه با استفاده از PodDisruptionBudget

1. مشخص کنید که می‌خواهید از کدام برنامه با PodDisruptionBudget (PDB) محافظت کنید.
1. به نحوه واکنش برنامه شما به اختلالات فکر کنید.
1. یک تعریف PDB به صورت یک فایل YAML ایجاد کنید.
1. شی PDB را از فایل YAML ایجاد کنید.

<!-- discussion -->

## مشخص کردن برنامه‌ای برای محافظت

رایج‌ترین مورد استفاده زمانی است که می‌خواهید از برنامه‌ای محافظت کنید که توسط یکی از کنترلرهای داخلی کوبرنتیز مشخص شده است:

- Deployment
- ReplicationController
- ReplicaSet
- StatefulSet

در این حالت، مشخصات `.spec.selector` کنترلر را یادداشت کنید؛ همان انتخاب‌گر در PDBs `.spec.selector` قرار می‌گیرد.

از نسخه 1.15 PDBها از کنترلرهای سفارشی پشتیبانی می‌کنند که در آن [زیرمنبع مقیاس](/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definitions/#scale-subresource) فعال است.

شما همچنین می‌توانید از PDBها با پادهایی که توسط یکی از کنترلرهای فوق کنترل نمی‌شوند، یا گروه‌های دلخواه پادها استفاده کنید، اما محدودیت‌هایی وجود دارد که در [بارهای کاری دلخواه و انتخاب‌گرهای دلخواه](#arbitrary-controllers-and-selectors) توضیح داده شده است.

## فکر کردن به نحوه واکنش برنامه شما به اختلالات

تصمیم بگیرید که چند نمونه می‌توانند به طور همزمان برای مدت کوتاهی به دلیل اختلال داوطلبانه از دسترس خارج شوند.

- فرانت‌اندهای بی‌حالت:
  - نگرانی: ظرفیت خدمت‌رسانی بیش از 10٪ کاهش نیابد.
    - راه حل: استفاده از PDB با minAvailable به مقدار 90٪ به عنوان مثال.
- برنامه حالت‌دار تک‌نمونه:
  - نگرانی: این برنامه بدون مشورت با من خاتمه نیابد.
    - راه حل ممکن 1: استفاده نکردن از PDB و تحمل زمان خاموشی موقت.
    - راه حل ممکن 2: تنظیم PDB با maxUnavailable=0. توافق داشتن (خارج از کوبرنتیز) که مدیر خوشه باید قبل از خاتمه با شما مشورت کند. هنگامی که مدیر خوشه با شما تماس می‌گیرد، برای خاموشی آماده شوید و سپس PDB را حذف کنید تا آمادگی برای اختلال را نشان دهید. بعد از آن دوباره PDB را ایجاد کنید.
- برنامه حالت‌دار چندنمونه‌ای مانند Consul، ZooKeeper یا etcd:
  - نگرانی: تعداد نمونه‌ها کمتر از حد نصاب نشود، در غیر این صورت نوشتن‌ها ناکام می‌مانند.
    - راه حل ممکن 1: تنظیم maxUnavailable به 1 (کاربرد در مقیاس‌های مختلف برنامه).
    - راه حل ممکن 2: تنظیم minAvailable به اندازه حد نصاب (مثلاً 3 زمانی که مقیاس 5 است). (اجازه دادن به اختلالات بیشتر به طور همزمان).
- شغل دسته‌ای قابل راه‌اندازی مجدد:
  - نگرانی: شغل باید در صورت اختلال داوطلبانه تکمیل شود.
    - راه حل ممکن: ایجاد نکردن PDB. کنترلر شغل یک پاد جایگزین ایجاد خواهد کرد.

### منطق گرد کردن هنگام مشخص کردن درصدها

مقادیر `minAvailable` یا `maxUnavailable` می‌توانند به صورت عدد صحیح یا درصد بیان شوند.

- زمانی که یک عدد صحیح مشخص می‌کنید، نشان‌دهنده تعداد پادها است. به عنوان مثال، اگر `minAvailable` را به 10 تنظیم کنید، 10 پاد باید همیشه در دسترس باشند، حتی در طول اختلال.
- زمانی که یک درصد را با تنظیم مقدار به نمایش رشته‌ای یک درصد (مثلاً `"50%"`) مشخص می‌کنید، نشان‌دهنده درصدی از کل پادها است. به عنوان مثال، اگر `minAvailable` را به `"50%"` تنظیم کنید، حداقل 50٪ از پادها در طول اختلال در دسترس می‌مانند.

هنگامی که مقدار را به عنوان درصد مشخص می‌کنید، ممکن است با تعداد دقیق پادها مطابقت نداشته باشد. برای مثال، اگر 7 پاد دارید و `minAvailable` را به `"50%"` تنظیم کنید، بلافاصله واضح نیست که آیا این به معنای 3 پاد یا 4 پاد است که باید در دسترس باشند. کوبرنتیز به نزدیکترین عدد صحیح گرد می‌کند، بنابراین در این مورد، 4 پاد باید در دسترس باشند. زمانی که مقدار `maxUnavailable` را به عنوان درصد مشخص می‌کنید، کوبرنتیز تعداد پادهایی که ممکن است مختل شوند را به بالا گرد می‌کند. بنابراین یک اختلال می‌تواند از درصد تعریف شده `maxUnavailable` شما تجاوز کند. می‌توانید [کد](https://github.com/kubernetes/kubernetes/blob/23be9587a0f8677eb8091464098881df939c44a9/pkg/controller/disruption/disruption.go#L539) که این رفتار را کنترل می‌کند بررسی کنید.

## مشخص کردن یک PodDisruptionBudget

یک `PodDisruptionBudget` سه فیلد دارد:

- یک انتخاب‌گر برچسب `.spec.selector` برای مشخص کردن مجموعه پادهایی که به آن اعمال می‌شود. این فیلد الزامی است.
- `.spec.minAvailable` که توضیحی از تعداد پادها از آن مجموعه است که پس از اخراج، حتی در غیاب پاد اخراج شده، باید همچنان در دسترس باشند. `minAvailable` می‌تواند یک عدد مطلق یا یک درصد باشد.
- `.spec.maxUnavailable` (در دسترس از کوبرنتیز 1.7 به بالا) که توضیحی از تعداد پادها از آن مجموعه است که پس از اخراج می‌توانند در دسترس نباشند. این مقدار می‌تواند یک عدد مطلق یا یک درصد باشد.

{{< note >}}
رفتار یک انتخاب‌گر خالی بین APIهای policy/v1beta1 و policy/v1 برای PodDisruptionBudgets متفاوت است. برای policy/v1beta1 یک انتخاب‌گر خالی هیچ پادی را تطابق نمی‌دهد، در حالی که برای policy/v1 یک انتخاب‌گر خالی تمام پادهای موجود در فضای نام را تطابق می‌دهد.
{{< /note >}}

شما می‌توانید تنها یکی از `maxUnavailable` و `minAvailable` را در یک `PodDisruptionBudget` مشخص کنید. `maxUnavailable` فقط می‌تواند برای کنترل اخراج پادهایی که یک کنترلر مدیریت آنها را دارد استفاده شود. در مثال‌های زیر، "تکرارهای مورد نظر" مقیاس کنترلری است که پادهای انتخاب شده توسط `PodDisruptionBudget` را مدیریت می‌کند.

مثال 1: با `minAvailable` به مقدار 5، اخراج‌ها مجاز هستند به شرطی که حداقل 5 پاد [سالم](#healthiness-of-a-pod) در میان آنهایی که توسط انتخاب‌گر PodDisruptionBudget انتخاب شده‌اند باقی بمانند.

مثال 2: با `minAvailable` به مقدار 30٪، اخراج‌ها مجاز هستند به شرطی که حداقل 30٪ از تعداد تکرارهای مورد نظر سالم باشند.

مثال 3: با `maxUnavailable` به مقدار 5، اخراج‌ها مجاز هستند به شرطی که حداکثر 5 تکرار ناسالم در میان کل تعداد تکرارهای مورد نظر وجود داشته باشد.

مثال 4: با `maxUnavailable` به مقدار 30٪، اخراج‌ها مجاز هستند به شرطی که تعداد تکرارهای ناسالم از 30٪ از کل تعداد تکرارهای مورد نظر که به نزدیک‌ترین عدد صحیح گرد شده است تجاوز نکند. اگر کل تعداد تکرارهای مورد نظر فقط یکی باشد، آن تکرار تنها همچنان برای اختلال مجاز است، که منجر به ناتوانی مؤثر 100٪ می‌شود.

در استفاده معمول، یک بودجه واحد برای یک مجموعه از پادهای مدیریت شده توسط یک کنترلر استفاده می‌شود—به عنوان مثال، پادهای موجود در یک ReplicaSet یا StatefulSet.

{{< note >}}
یک بودجه اختلال به‌طور واقعی تضمین نمی‌کند که تعداد/درصد مشخصی از پادها همیشه فعال باشند. به عنوان مثال، یک نود که یک پاد از مجموعه را میزبانی می‌کند ممکن است زمانی که مجموعه در حداقل اندازه مشخص شده در بودجه است، شکست بخورد، در نتیجه تعداد پادهای در دسترس از مجموعه کمتر از اندازه مشخص شده می‌شود. بودجه فقط می‌تواند در برابر اخراج‌های داوطلبانه محافظت کند، نه همه دلایل عدم دسترسی.
{{< /note >}}

اگر `maxUnavailable` را به 0٪ یا 0 تنظیم کنید، یا `minAvailable` را به 100٪ یا تعداد تکرارها تنظیم کنید، شما هیچ اخراج داوطلبانه‌ای را مجاز نمی‌دانید. زمانی که شما اخراج‌های داوطلبانه صفر را برای یک شی کاری مانند ReplicaSet تنظیم می‌کنید، نمی‌توانید یک نود را که یکی از این پادها در حال اجرا است با موفقیت تخلیه کنید. اگر سعی کنید یک نود را که یک پاد غیرقابل اخراج در حال اجرا است تخلیه کنید، تخلیه هرگز کامل نمی‌شود. این مجاز است طبق معانی `PodDisruptionBudget`.

می‌توانید مثال‌هایی از بودجه‌های اختلال پاد را در زیر پیدا کنید. آنها پادهایی را با برچسب `app: zookeeper` مطابقت می‌دهند.

مثال PDB با استفاده از minAvailable:

{{% code_sample file="policy/zookeeper-pod-disruption-budget-minavailable.yaml" %}}

مثال PDB با استفاده از maxUnavailable:

{{% code_sample file="policy/zookeeper-pod-disruption-budget-maxunavailable.yaml" %}}

برای مثال، اگر شی `zk-pdb` فوق پادهای یک StatefulSet با اندازه 3 را انتخاب کند، هر دو مشخصات دقیقاً همان معنا را دارند. استفاده از `maxUnavailable` توصیه می‌شود زیرا به صورت خودکار به تغییرات در تعداد تکرارهای کنترلر مربوطه پاسخ می‌دهد.

## ایجاد شئ PDB

می‌توانید شئ PDB را با استفاده از kubectl ایجاد یا به‌روزرسانی کنید.
```shell
kubectl apply -f mypdb.yaml
```

## بررسی وضعیت PDB

از kubectl برای بررسی اینکه PDB شما ایجاد شده است، استفاده کنید.

فرض کنید در namespace شما پادهایی با `app: zookeeper` موجود نیست، در این صورت چیزی شبیه به این خواهید دید:

```shell
kubectl get poddisruptionbudgets
```
```
NAME     MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
zk-pdb   2               N/A               0                     7s
```

اگر پادهای مطابق (مثلاً 3 عدد) موجود باشند، چیزی شبیه به این خواهید دید:

```shell
kubectl get poddisruptionbudgets
```
```
NAME     MIN AVAILABLE   MAX UNAVAILABLE   ALLOWED DISRUPTIONS   AGE
zk-pdb   2               N/A               1                     7s
```

مقدار غیر صفر برای `ALLOWED DISRUPTIONS` به این معنی است که کنترل‌کننده اختلال پادها را مشاهده کرده، پادهای مطابق را شمارش کرده و وضعیت PDB را به‌روز کرده است.

می‌توانید با این فرمان اطلاعات بیشتری درباره وضعیت PDB دریافت کنید:

```shell
kubectl get poddisruptionbudgets zk-pdb -o yaml
```
```yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  annotations:
…
  creationTimestamp: "2020-03-04T04:22:56Z"
  generation: 1
  name: zk-pdb
…
status:
  currentHealthy: 3
  desiredHealthy: 2
  disruptionsAllowed: 1
  expectedPods: 3
  observedGeneration: 1
```

### سلامت یک پاد

پیاده‌سازی فعلی پادهای سالم را به‌عنوان پادهایی در نظر می‌گیرد که دارای آیتم `.status.conditions` با `type="Ready"` و `status="True"` هستند.
این پادها از طریق فیلد `.status.currentHealthy` در وضعیت PDB پیگیری می‌شوند.

## سیاست اخراج پاد ناسالم

{{< feature-state feature_gate_name="PDBUnhealthyPodEvictionPolicy" >}}

{{< note >}}
این ویژگی به طور پیش‌فرض فعال است. می‌توانید با غیرفعال کردن `PDBUnhealthyPodEvictionPolicy` 
[feature gate](/docs/reference/command-line-tools-reference/feature-gates/)
روی [API server](/docs/reference/command-line-tools-reference/kube-apiserver/) آن را غیرفعال کنید.
{{< /note >}}

بودجه اختلال پاد که از یک برنامه محافظت می‌کند، اطمینان حاصل می‌کند که تعداد پادهای `.status.currentHealthy`
پایین‌تر از عدد مشخص‌شده در `.status.desiredHealthy` نمی‌رود و با اخراج پادهای سالم مخالف است.
با استفاده از `.spec.unhealthyPodEvictionPolicy`، می‌توانید معیارهایی را تعیین کنید که در آن‌ها پادهای ناسالم برای اخراج در نظر گرفته شوند. رفتار پیش‌فرض وقتی سیاستی مشخص نشده باشد، با سیاست `IfHealthyBudget` مطابقت دارد.

سیاست‌ها:

`IfHealthyBudget`
: پادهای در حال اجرا (`.status.phase="Running"`)، اما هنوز سالم نیستند فقط می‌توانند اخراج شوند
  اگر برنامه محافظت‌شده مختل نباشد (`.status.currentHealthy` حداقل برابر با `.status.desiredHealthy` باشد).

: این سیاست اطمینان می‌دهد که پادهای در حال اجرای یک برنامه مختل‌شده بهترین شانس را برای سالم شدن دارند. این امر پیامدهای منفی برای تخلیه نودها دارد، که می‌توانند توسط برنامه‌های مخرب که توسط یک PDB محافظت می‌شوند، مسدود شوند. به طور خاص برنامه‌هایی با پادهایی در حالت `CrashLoopBackOff`
  (به دلیل یک باگ یا تنظیمات نادرست)، یا پادهایی که فقط موفق به گزارش شرایط `Ready` نمی‌شوند.

`AlwaysAllow`
: پادهای در حال اجرا (`.status.phase="Running"`)، اما هنوز سالم نیستند، مختل‌شده در نظر گرفته می‌شوند و می‌توانند صرف‌نظر از اینکه معیارهای یک PDB رعایت می‌شود، اخراج شوند.

: این بدان معناست که پادهای در حال اجرای یک برنامه مختل ممکن است شانس سالم شدن را نداشته باشند. با استفاده از این سیاست، مدیران خوشه می‌توانند به‌راحتی برنامه‌های مخرب که توسط یک PDB محافظت می‌شوند را اخراج کنند. به طور خاص برنامه‌هایی با پادهایی در حالت `CrashLoopBackOff`
  (به دلیل یک باگ یا تنظیمات نادرست)، یا پادهایی که فقط موفق به گزارش شرایط `Ready` نمی‌شوند.

{{< note >}}
پادهای در حالت `Pending`، `Succeeded` یا `Failed` همیشه برای اخراج در نظر گرفته می‌شوند.
{{< /note >}}

## بارهای کاری دلخواه و انتخاب‌کننده‌های دلخواه {#arbitrary-controllers-and-selectors}

می‌توانید این بخش را نادیده بگیرید اگر فقط از PDBها با منابع کاری داخلی (Deployment، ReplicaSet، StatefulSet و ReplicationController) یا با {{< glossary_tooltip term_id="CustomResourceDefinition" text="منابع سفارشی" >}}
که یک `scale` [زیرمنبع](/docs/concepts/extend-kubernetes/api-extension/custom-resources/#advanced-features-and-flexibility) را پیاده‌سازی می‌کنند،
و جایی که انتخاب‌کننده PDB دقیقاً با انتخاب‌کننده منبع مالک پاد مطابقت دارد.

می‌توانید از یک PDB با پادهای کنترل‌شده توسط یک منبع دیگر، توسط یک
"اپراتور"، یا پادهای مستقل استفاده کنید، اما با این محدودیت‌ها:

- فقط `.spec.minAvailable` می‌تواند استفاده شود، نه `.spec.maxUnavailable`.
- فقط یک مقدار عدد صحیح می‌تواند با `.spec.minAvailable` استفاده شود، نه یک درصد.

امکان استفاده از سایر پیکربندی‌های در دسترس نیست،
زیرا کوبرنتیز نمی‌تواند تعداد کل پادها را بدون یک منبع مالک پشتیبانی‌شده استخراج کند.

می‌توانید از یک انتخاب‌کننده که یک زیرمجموعه یا بیش‌مجموعه‌ای از پادهای متعلق به یک
منبع کاری را انتخاب می‌کند، استفاده کنید. API اخراج اخراج هیچ پادی که تحت پوشش PDBهای متعدد باشد را مجاز نمی‌داند،
بنابراین بیشتر کاربران می‌خواهند از انتخاب‌کننده‌های هم‌پوشانی اجتناب کنند. یک استفاده معقول از PDBهای هم‌پوشانی زمانی است که پادها از یک PDB به PDB دیگری منتقل می‌شوند.
